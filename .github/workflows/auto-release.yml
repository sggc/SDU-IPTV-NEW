name: Auto Release on Changes

on:
  push:
    branches: [ main, master ]
    paths:
      - '**'  # ç›‘æ§æ‰€æœ‰æ–‡ä»¶å˜åŒ–
      - '!.github/**'  # æ’é™¤.githubç›®å½•è‡ªèº«çš„å˜åŒ–é¿å…å¾ªç¯è§¦å‘

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      has-changes: ${{ steps.check.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Check for file changes
        id: check
        uses: dorny/paths-filter@v2
        with:
          filters: |
            has_changes:
              - '**'
              - '!.github/**'

  create-release:
    needs: check-changes
    if: needs.check-changes.outputs.has-changes == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup release version
        id: setup
        run: |
          # è·å–å½“å‰æ—¥æœŸï¼ˆç®€åŒ–æ ¼å¼ï¼Œå»æ‰å‰å¯¼é›¶ï¼‰
          CURRENT_DATE=$(date +"%Y.%-m.%-d")
          
          # è·å–ä»Šå¤©å·²æœ‰çš„å‘å¸ƒæ•°é‡ï¼ˆåŒ¹é…æ–°æ ¼å¼ï¼‰
          TODAY_RELEASES=$(gh api repos/${{ github.repository }}/releases --jq ".[] | select(.tag_name | startswith(\"$CURRENT_DATE-\")) | .tag_name" | wc -l)
          
          # è®¡ç®—æ–°å‘å¸ƒçš„åºå·
          RELEASE_NUMBER=$((TODAY_RELEASES + 1))
          
          # ç”Ÿæˆå‘å¸ƒåç§°å’Œæ ‡ç­¾
          RELEASE_NAME="$CURRENT_DATE-r$RELEASE_NUMBER"
          RELEASE_TAG="$RELEASE_NAME"
          
          echo "RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_OUTPUT
          echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "RELEASE_DATE=$CURRENT_DATE" >> $GITHUB_OUTPUT
          echo "RELEASE_NUMBER=$RELEASE_NUMBER" >> $GITHUB_OUTPUT
          echo "å‡†å¤‡åˆ›å»ºå‘å¸ƒ: $RELEASE_NAME"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Get changed files
        id: changed_files
        run: |
          # è·å–å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            # åˆå§‹æäº¤çš„æƒ…å†µ
            echo "å˜æ›´ç±»å‹: åˆå§‹æäº¤"
            echo "FILES_CHANGED=$(git show --pretty=format: --name-only ${{ github.sha }} | tr '\n' ',' | sed 's/,$//')" >> $GITHUB_OUTPUT
          else
            # æ™®é€šæäº¤çš„æƒ…å†µ
            echo "å˜æ›´ç±»å‹: æ™®é€šæäº¤"
            echo "FILES_CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | tr '\n' ',' | sed 's/,$//')" >> $GITHUB_OUTPUT
          fi
          
      - name: Generate release notes
        id: release_notes
        run: |
          # ç”Ÿæˆè¯¦ç»†çš„å‘å¸ƒè¯´æ˜
          NOTES="# ç‰ˆæœ¬ ${{ steps.setup.outputs.RELEASE_NAME }}

**å‘å¸ƒä¿¡æ¯**
- **ç‰ˆæœ¬å·:** ${{ steps.setup.outputs.RELEASE_NAME }}
- **å‘å¸ƒæ—¶é—´:** $(date)
- **æäº¤å“ˆå¸Œ:** [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
- **æäº¤ä¿¡æ¯:** ${{ github.event.head_commit.message }}

## å˜æ›´æ–‡ä»¶åˆ—è¡¨
"

          # æ·»åŠ å˜æ›´æ–‡ä»¶åˆ—è¡¨
          IFS=',' read -ra FILES <<< "${{ steps.changed_files.outputs.FILES_CHANGED }}"
          FILE_COUNT=0
          for file in "${FILES[@]}"; do
            if [ -n "$file" ]; then
              NOTES="$NOTES
- \`$file\`"
              FILE_COUNT=$((FILE_COUNT + 1))
            fi
          done
          
          if [ $FILE_COUNT -eq 0 ]; then
            NOTES="$NOTES
> æœªæ£€æµ‹åˆ°å…·ä½“æ–‡ä»¶å˜æ›´"
          else
            NOTES="$NOTES

> å…±æ£€æµ‹åˆ° $FILE_COUNT ä¸ªæ–‡ä»¶å˜æ›´"
          fi
          
          NOTES="$NOTES

---

*æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*"
          
          # ä¿å­˜åˆ°æ–‡ä»¶ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "$NOTES" > release_notes.md
          echo "ç”Ÿæˆå‘å¸ƒè¯´æ˜å®Œæˆï¼Œå…± $FILE_COUNT ä¸ªå˜æ›´æ–‡ä»¶"
          
      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.setup.outputs.RELEASE_TAG }}
          release_name: ${{ steps.setup.outputs.RELEASE_NAME }}
          body_path: release_notes.md
          draft: false
          prerelease: false

      - name: Show release info
        run: |
          echo "âœ… å‘å¸ƒåˆ›å»ºæˆåŠŸ: ${{ steps.setup.outputs.RELEASE_NAME }}"
          echo "ğŸ“ å‘å¸ƒé¡µé¢: https://github.com/${{ github.repository }}/releases/tag/${{ steps.setup.outputs.RELEASE_TAG }}"
